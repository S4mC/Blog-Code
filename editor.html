<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Markdown Editor</title>
        <link rel="icon" type="image/png" sizes="32x32" href="public/Icon.ico">
        <link rel="stylesheet" href="cdn/font/ubuntu-font.css" />
        <link rel="stylesheet" href="styles.css" />
        <link rel="stylesheet" href="styles-editor.css" />
        <link rel="stylesheet" href="cdn/prism/prism-dark-svc.css" />
        <link rel="stylesheet" href="cdn/monaco/editor.main.min.css" />
        <script src="cdn/prism/prism-core.min.js"></script>
        <script src="cdn/prism/prism-autoloader.min.js"></script>
        <script src="cdn/marked/marked.umd.js"></script>
        <script src="cdn/SVGpanzoom/svg-pan-zoom.min.js"></script>
        <script src="cdn/monaco/vs/loader.js"></script>
        <!-- <script src="components/script-all-pages.js"></script> -->
        <script type="importmap">
            {
                "imports": {
                    "preact": "./cdn/preact/preact.mjs",
                    "preact/hooks": "./cdn/preact/hooks.mjs",
                    "htm/preact": "./cdn/preact/htm-preact.mjs"
                }
            }
        </script>
    </head>
    <body>
        <div id="app"></div>

        <script type="module">
            import { render } from "preact";
            import { useState, useEffect, useRef } from "preact/hooks";
            import { html } from "htm/preact";
            import { Header } from "./components/Header.js";
            import { Sidebar, initSidebar } from "./components/Sidebar.js";
            import {
                renderMarkdown,
                showCopySuccess,
                manageEscapeIframe,
                manageClickFloatButton,
            } from "./components/markdownProcessor.js";

            // Configure Monaco Editor
            require.config({
                paths: {
                    vs: "./cdn/monaco/vs",
                },
            });
            
            // Configure the languages we want to load
            window.MonacoEnvironment = {
                getLanguages: function() {
                    return ['markdown'];
                }
            };

            // Handler for Escape key
            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape") {
                    manageEscapeIframe();
                }
            });

            document.addEventListener("click", function (e) {
                manageClickFloatButton(e);

                // For the main copy button
                if (e.target.closest(".copy-button")) {
                    const button = e.target.closest(".copy-button");
                    const originalHTML = button.innerHTML;

                    if (window.handleCopy) {
                        window
                            .handleCopy()
                            .then(() => {
                                showCopySuccess(button, originalHTML);
                            })
                            .catch((err) => {
                                console.error("Error copying:", err);
                            });
                    }
                }
            });

            function MarkdownEditor() {
                const handleNavigateToEntry = (entry) => {
                    window.location.href = `./post.html?path=${encodeURIComponent(entry.path)}`;
                };

                const [markdown, setMarkdown] = useState(`# My First Entry

This is an example of a **blog entry** with *italic text*.

## Feature List

- Support for **bold** and *italic*
- Numbered and bullet lists
- \`inline code\`
- Links: [Example](https://example.com)

:::details-open Collapsible Element
### This item is open by default
content
:::

### SVG Container

\`\`\`svgcontainer style="height:15em;"
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 21q-.825 0-1.412-.587T1 19V5q0-.825.588-1.412T3 3h18q.825 0 1.413.588T23 5v14q0 .825-.587 1.413T21 21zm4-4h2V7H5v2h2zm4.5 0h2l1.75-3.175L17 17h2l-2.75-5L19 7h-2l-1.75 3.175L13.5 7h-2l2.75 5z"/></svg>
\`\`\`

### Code Block

\`\`\`javascript
function hello() {
    console.log("Hello world!");
}
\`\`\`

### Example Table

| Column 1 | Column 2 | Column 3 |
|----------|----------|----------|
| Cell A   | Cell B   | Cell C   |
| Cell D   | Cell E   | Cell F   |

### Embedded Iframe

:::iframe
https://example.com
:::

### Blockquote

> This is a
> blockquote`);

                const [preview, setPreview] = useState("");
                const [showPreview, setShowPreview] = useState(false);
                const [previewPosition, setPreviewPosition] = useState("right"); // 'right' o 'bottom'
                const editorRef = useRef(null);
                const containerRef = useRef(null);

                useEffect(() => {
                    if (showPreview){
                        let [finalHtml, sidebarContent, finalJS] = renderMarkdown(markdown);
                        setPreview(finalHtml);
                        setTimeout(() => {
                            // Usar la función initSidebar que maneja de forma segura la inicialización/actualización
                            initSidebar(sidebarContent);
                            eval(finalJS);
                        }, 100);
                    }
                }, [showPreview, markdown]);

                useEffect(() => {
                    if (showPreview) {
                        setTimeout(() => {
                            if (window.Prism) {
                                window.Prism.highlightAll();
                            }
                        }, 100);
                    }
                }, [showPreview, preview]);

                useEffect(() => {
                    if (!editorRef.current) {
                        // La configuración ya está hecha arriba

                        require(["vs/editor/editor.main"], () => {
                            editorRef.current = monaco.editor.create(
                                containerRef.current,
                                {
                                    value: markdown,
                                    language: "markdown",
                                    theme: "vs-dark",
                                    minimap: { enabled: true },
                                    fontSize: 16,
                                    lineNumbers: "on",
                                    roundedSelection: false,
                                    scrollBeyondLastLine: false,
                                    wordWrap: "on",
                                    acceptSuggestionOnEnter: "off",
                                    automaticLayout: true,
                                    smoothScrolling: true,
                                }
                            );

                            editorRef.current.onDidChangeModelContent(() => {
                                setMarkdown(editorRef.current.getValue());
                            });
                        });
                    }
                }, []);

                const insertText = (
                    beforeText,
                    afterText = "",
                    insertAtStart = false
                ) => {
                    if (!editorRef.current) return;

                    const editor = editorRef.current;
                    const selection = editor.getSelection();
                    const selectedText = editor
                        .getModel()
                        .getValueInRange(selection);

                    // If no text is selected and insertAtStart is true
                    if (selection.isEmpty() && insertAtStart) {
                        const lineNumber = selection.startLineNumber;
                        const lineContent = editor
                            .getModel()
                            .getLineContent(lineNumber);

                        // Detect if there's already a header at the beginning
                        const headerRegex = /^(#{1,6}\s|#t\s)/;
                        const match = lineContent.match(headerRegex);

                        const lineStart = {
                            startLineNumber: lineNumber,
                            startColumn: 1,
                            endLineNumber: lineNumber,
                            endColumn: lineContent.length + 1,
                        };

                        let newText;
                        if (match) {
                            // If there's already a header, replace it
                            newText =
                                beforeText +
                                lineContent.substring(match[0].length) +
                                afterText;
                        } else {
                            // If there's no header, add a new one
                            newText = beforeText + lineContent + afterText;
                        }

                        // Edit at the beginning of the line
                        editor.executeEdits("", [
                            {
                                range: lineStart,
                                text: newText,
                            },
                        ]);
                    } else {
                        // Normal behavior when text is selected
                        const newText = beforeText + selectedText + afterText;

                        // Realiza la edición
                        editor.executeEdits("", [
                            {
                                range: selection,
                                text: newText,
                            },
                        ]);
                    }
                    // Calculate where the cursor will be: right after beforeText + selectedText
                    let lines = (beforeText + selectedText).split("\n");
                    let newLineNumber =
                        selection.startLineNumber + (lines.length - 1);
                    let newColumn;

                    if (lines.length === 1) {
                        // Everything on the same line
                        newColumn = selection.startColumn + lines[0].length;
                    } else {
                        // Last line of the block
                        newColumn = lines[lines.length - 1].length + 1;
                    }

                    // Posiciona el cursor
                    editor.setSelection({
                        startLineNumber: newLineNumber,
                        startColumn: newColumn,
                        endLineNumber: newLineNumber,
                        endColumn: newColumn,
                    });

                    // Center the cursor line on the screen with smooth animation
                                        // Center the cursor line on the screen
                    editor.revealLineInCenter(newLineNumber, monaco.editor.ScrollType.Smooth);
                    
                    editor.focus();
                };

                const handleSave = () => {
                    const blob = new Blob([markdown], {
                        type: "text/markdown",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "post.md";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                const handleCopy = async () => {
                    try {
                        await navigator.clipboard.writeText(markdown);
                        return Promise.resolve();
                    } catch (err) {
                        console.error("Error copying to clipboard:", err);
                        return Promise.reject(err);
                    }
                };

                // Make the handleCopy function globally accessible
                window.handleCopy = handleCopy;

                const handleExport = () => {
                    const blob = new Blob([preview], { type: "text/html" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "post.html";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                const insertIframe = () => {
                    const url = prompt("Enter the iframe URL:");
                    if (url) {
                        insertText(`\n:::iframe height="27em"\n${url}\n:::\n`);
                    }
                };

                return html`
                    <div class="app">
                        <${Header} 
                            showSearch=${true} 
                            onNavigateToEntry=${(entry) => {
                                window.location.href = `./post.html?path=${encodeURIComponent(entry.path)}`;
                            }} 
                        />

                        <main class="main-container">
                            <${Sidebar} />
                            <div class="editor-container">
                                <div
                                    style="display: flex; gap: var(--spacing-sm); padding: var(--spacing-sm); background-color: var(--bg-secondary); border-bottom: none; border-radius: var(--border-radius) var(--border-radius) 0 0; align-items: center;justify-content: space-between;"
                                >
                                    <div class="editor-menu">
                                        <button
                                            class="menu-trigger"
                                            onClick=${(e) => {
                                                const menu =
                                                    e.currentTarget
                                                        .nextElementSibling;
                                                const isVisible =
                                                    menu.style.display ===
                                                    "block";
                                                menu.style.display = isVisible
                                                    ? "none"
                                                    : "block";

                                                if (!isVisible) {
                                                    const closeMenu = (
                                                        event
                                                    ) => {
                                                        if (
                                                            !menu.contains(
                                                                event.target
                                                            ) &&
                                                            !e.target.contains(
                                                                event.target
                                                            )
                                                        ) {
                                                            menu.style.display =
                                                                "none";
                                                            document.removeEventListener(
                                                                "click",
                                                                closeMenu
                                                            );
                                                        }
                                                    };
                                                    // Usar setTimeout para evitar que el evento click actual cierre inmediatamente el menú
                                                    setTimeout(
                                                        () =>
                                                            document.addEventListener(
                                                                "click",
                                                                closeMenu
                                                            ),
                                                        0
                                                    );
                                                }
                                            }}
                                        >
                                            <svg
                                                width="16"
                                                height="16"
                                                viewBox="0 0 16 16"
                                                fill="none"
                                                xmlns="http://www.w3.org/2000/svg"
                                            >
                                                <path
                                                    d="M2 4h12M2 8h12M2 12h12"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                    stroke-linecap="round"
                                                />
                                            </svg>
                                        </button>
                                        <div
                                            class="menu-content"
                                            style="display: none;"
                                        >
                                            <button onClick=${handleSave}>
                                                <svg
                                                    width="16"
                                                    height="16"
                                                    viewBox="0 0 16 16"
                                                    fill="none"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                >
                                                    <path
                                                        d="M13 13H3a2 2 0 01-2-2V3a2 2 0 012-2h8l4 4v6a2 2 0 01-2 2z"
                                                        stroke="currentColor"
                                                        stroke-width="2"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                    />
                                                </svg>
                                                Guardar (.md)
                                            </button>
                                            <button onClick=${handleExport}>
                                                <svg
                                                    width="16"
                                                    height="16"
                                                    viewBox="0 0 16 16"
                                                    fill="none"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                >
                                                    <path
                                                        d="M14 10v2a2 2 0 01-2 2H4a2 2 0 01-2-2v-2M8 2v8M5 5l3-3 3 3"
                                                        stroke="currentColor"
                                                        stroke-width="2"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                    />
                                                </svg>
                                                Exportar HTML
                                            </button>
                                        </div>
                                    </div>
                                    <div class="editor-toolbar">
                                        <button
                                            onClick=${() =>
                                                insertText("**", "**")}
                                            title="Negrita"
                                        >
                                            <strong>B</strong>
                                        </button>
                                        <button
                                            onClick=${() =>
                                                insertText("*", "*")}
                                            title="Cursiva"
                                        >
                                            <em>C</em>
                                        </button>
                                        <button
                                            class="editor-menu"
                                            onClick=${(e) => {
                                                if (
                                                    e.target === e.currentTarget
                                                ) {
                                                    const menu =
                                                        e.currentTarget.querySelector(
                                                            ".menu-content"
                                                        );
                                                    const isVisible =
                                                        menu.style.display ===
                                                        "block";
                                                    menu.style.display =
                                                        isVisible
                                                            ? "none"
                                                            : "block";

                                                    if (!isVisible) {
                                                        const closeMenu = (
                                                            event
                                                        ) => {
                                                            if (
                                                                !menu.contains(
                                                                    event.target
                                                                ) &&
                                                                !e.target.contains(
                                                                    event.target
                                                                )
                                                            ) {
                                                                menu.style.display =
                                                                    "none";
                                                                document.removeEventListener(
                                                                    "click",
                                                                    closeMenu
                                                                );
                                                            }
                                                        };
                                                        setTimeout(
                                                            () =>
                                                                document.addEventListener(
                                                                    "click",
                                                                    closeMenu
                                                                ),
                                                            0
                                                        );
                                                    }
                                                }
                                            }}
                                            title="Código"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 18" style="pointer-events: none;"><path fill="currentColor" d="m8 18l-6-6l6-6l1.425 1.425l-4.6 4.6L9.4 16.6zm8 0l-1.425-1.425l4.6-4.6L14.6 7.4L16 6l6 6z"/></svg>
                                            <div
                                                class="menu-content"
                                                style="display: none;"
                                            >
                                                <button
                                                    onClick=${(e) => {
                                                        insertText("`", "`");
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    Código en línea
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "\n```\n",
                                                            "\n```\n"
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    Bloque de código
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "\n```python\n",
                                                            "\n```\n"
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    Bloque Python
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "\n```markdown\n",
                                                            "\n```\n"
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    Bloque Markdown
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "\n```javascript\n",
                                                            "\n```\n"
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    Bloque JavaScript
                                                </button>
                                            </div>
                                        </button>
                                        <button
                                            onClick=${() =>
                                                insertText("[", " new](url)")}
                                            title="Enlace"
                                        >
                                            🔗
                                        </button>
                                        <button
                                            onClick=${() =>
                                                insertText("![alt](", ")")}
                                            title="Imagen"
                                        >
                                            🖼️
                                        </button>
                                        <button
                                            onClick=${insertIframe}
                                            title="Iframe"
                                        >
                                            📺
                                        </button>
                                        <div class="toolbar-separator"></div>
                                        <button
                                            class="editor-menu"
                                            onClick=${(e) => {
                                                // Solo actuar si el click fue directamente en el botón principal (no en los hijos)
                                                if (
                                                    e.target === e.currentTarget
                                                ) {
                                                    const menu =
                                                        e.currentTarget.querySelector(
                                                            ".menu-content"
                                                        );
                                                    const isVisible =
                                                        menu.style.display ===
                                                        "block";
                                                    menu.style.display =
                                                        isVisible
                                                            ? "none"
                                                            : "block";

                                                    if (!isVisible) {
                                                        const closeMenu = (
                                                            event
                                                        ) => {
                                                            if (
                                                                !menu.contains(
                                                                    event.target
                                                                ) &&
                                                                !e.target.contains(
                                                                    event.target
                                                                )
                                                            ) {
                                                                menu.style.display =
                                                                    "none";
                                                                document.removeEventListener(
                                                                    "click",
                                                                    closeMenu
                                                                );
                                                            }
                                                        };
                                                        setTimeout(
                                                            () =>
                                                                document.addEventListener(
                                                                    "click",
                                                                    closeMenu
                                                                ),
                                                            0
                                                        );
                                                    }
                                                }
                                            }}
                                            title="Encabezado"
                                        >
                                            H
                                            <div
                                                class="menu-content"
                                                style="display: none;"
                                            >
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "# ",
                                                            "",
                                                            true
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    H1 - Título Principal
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "## ",
                                                            "",
                                                            true
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    H2 - Subtítulo
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "### ",
                                                            "",
                                                            true
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    H3 - Encabezado 3
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "#### ",
                                                            "",
                                                            true
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    H4 - Encabezado 4
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "##### ",
                                                            "",
                                                            true
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    H5 - Encabezado 5
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "###### ",
                                                            "",
                                                            true
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    H6 - Encabezado 6
                                                </button>
                                                <button
                                                    onClick=${(e) => {
                                                        insertText(
                                                            "#t ",
                                                            "",
                                                            true
                                                        );
                                                        e.currentTarget.parentElement.style.display =
                                                            "none";
                                                    }}
                                                >
                                                    Text - Texto Normal
                                                </button>
                                            </div>
                                        </button>
                                        <button
                                            onClick=${() =>
                                                insertText("- ", "")}
                                            title="Lista"
                                        >
                                            📋
                                        </button>
                                        <button
                                            onClick=${() =>
                                                insertText("> ", "")}
                                            title="Cita"
                                        >
                                            💬
                                        </button>
                                        <button
                                            onClick=${() =>
                                                insertText('\n```svgcontainer style="height:15em;"\n', "\n```\n")}
                                            title="SVG Container"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 22 18" style="pointer-events: none;"><path fill="currentColor" d="M8.5 16.5h2q.425 0 .713-.288t.287-.712v-2q0-.425-.288-.712T10.5 12.5h-2q-.425 0-.712.288T7.5 13.5v2q0 .425.288.713t.712.287m0-5h2q.425 0 .713-.288t.287-.712v-2q0-.425-.288-.712T10.5 7.5h-2q-.425 0-.712.288T7.5 8.5v2q0 .425.288.713t.712.287m5 5h2q.425 0 .713-.288t.287-.712v-2q0-.425-.288-.712T15.5 12.5h-2q-.425 0-.712.288t-.288.712v2q0 .425.288.713t.712.287m0-5h2q.425 0 .713-.288t.287-.712v-2q0-.425-.288-.712T15.5 7.5h-2q-.425 0-.712.288T12.5 8.5v2q0 .425.288.713t.712.287M4 20q-.825 0-1.412-.587T2 18V6q0-.825.588-1.412T4 4h16q.825 0 1.413.588T22 6v12q0 .825-.587 1.413T20 20zm0-2h16V6H4zm0 0V6z"></path></svg>
                                        </button>
                                        <button
                                            onClick=${() =>
                                                insertText("\n:::details-open Collapsible Element\n", "\n:::\n")}
                                            title="Collapsible Element"
                                        >
                                            ▼
                                        </button>
                                        <div class="toolbar-separator"></div>
                                        <button
                                            onClick=${() =>
                                                setShowPreview(!showPreview)}
                                            class=${showPreview ? "active" : ""}
                                            title="Mostrar/Ocultar vista previa"
                                        >
                                            👁️
                                        </button>
                                        <button
                                            onClick=${() =>
                                                setPreviewPosition(
                                                    previewPosition === "right"
                                                        ? "bottom"
                                                        : "right"
                                                )}
                                            class=${showPreview
                                                ? ""
                                                : "disabled"}
                                            title="Cambiar posición de vista previa"
                                            disabled=${!showPreview}
                                        >
                                            🔄
                                        </button>
                                    </div>
                                    <button
                                        onClick=${handleCopy}
                                        class="copy-button"
                                        style="display: contents;"
                                    >
                                        <svg
                                            width="16"
                                            height="16"
                                            viewBox="0 0 16 16"
                                            fill="none"
                                            xmlns="http://www.w3.org/2000/svg"
                                            style="min-width: 16px; min-height: 16px;"
                                        >
                                            <path
                                                d="M13 13H7a2 2 0 01-2-2V5a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2z"
                                                stroke="currentColor"
                                                stroke-width="2"
                                            />
                                            <path
                                                d="M3 11V3a2 2 0 012-2h6"
                                                stroke="currentColor"
                                                stroke-width="2"
                                                stroke-linecap="round"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <div
                                    class="editor-content ${previewPosition} ${!showPreview
                                        ? "preview-hidden"
                                        : ""}"
                                >
                                    <div
                                        ref=${containerRef}
                                        class="monaco-editor-container"
                                        style="display: ${showPreview &&
                                        previewPosition == "bottom"
                                            ? "none"
                                            : "flex"};"
                                        value=${markdown}
                                    />
                                    <div
                                        class="markdown-preview entry-content"
                                        dangerouslySetInnerHTML=${{
                                            __html: preview,
                                        }}
                                    />
                                </div>
                            </div>
                        </main>

                        <footer class="footer">
                            <p>© 2025 Blog Code.</p>
                        </footer>
                    </div>
                `;
            }

            render(html`<${MarkdownEditor} />`, document.getElementById("app"));
            
            // Inicializar la barra lateral después de renderizar
            // Con un pequeño timeout para asegurar que el DOM está listo
            setTimeout(() => {
                initSidebar([]);
            }, 0);
        </script>
    </body>
</html>
