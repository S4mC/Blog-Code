<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Blog Entry</title>
        <link rel="icon" type="image/png" sizes="32x32" href="public/Icon.ico">
        <link rel="stylesheet" href="cdn/font/ubuntu-font.css" />
        <link rel="stylesheet" href="styles.css" />
        <link rel="stylesheet" href="styles-post.css" />
        <link rel="stylesheet" href="cdn/prism/prism-dark-svc.css" />
        <script src="cdn/prism/prism-core.min.js"></script>
        <script src="cdn/prism/prism-autoloader.min.js"></script>
        <script src="cdn/marked/marked.umd.js"></script>
        <script src="cdn/SVGpanzoom/svg-pan-zoom.min.js"></script>
        <!-- <script src="components/script-all-pages.js"></script> -->
        <script type="importmap">
            {
                "imports": {
                    "preact": "./cdn/preact/preact.mjs",
                    "preact/hooks": "./cdn/preact/hooks.mjs",
                    "htm/preact": "./cdn/preact/htm-preact.mjs"
                }
            }
        </script>
    </head>
    <body>
        <div id="app"></div>

        <script type="module">
            import { render } from "preact";
            import { useState, useEffect, useRef } from "preact/hooks";
            import { html } from "htm/preact";
            import { Header } from "./components/Header.js";
            import { Sidebar, initSidebar } from "./components/Sidebar.js";
            import {
                renderMarkdown,
                showCopySuccess,
                manageEscapeIframe,
                manageClickFloatButton,
            } from "./components/markdownProcessor.js";

            // Handler for Escape key
            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape") {
                    manageEscapeIframe();
                }
            });

            document.addEventListener("click", function (e) {
                manageClickFloatButton(e);
            });

            function BlogEntry() {
                const [content, setContent] = useState("");
                const [title, setTitle] = useState("");
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);

                const handleNavigateToEntry = (entry) => {
                    window.location.href = `./post.html?path=${encodeURIComponent(entry.path)}`;
                };

                useEffect(() => {
                    const urlParams = new URLSearchParams(
                        window.location.search
                    );
                    const entryPath = urlParams.get("path");

                    if (!entryPath) {
                        setError("Entry path not specified");
                        setLoading(false);
                        return;
                    }

                    // Load Markdown file
                    fetch(entryPath)
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error(
                                    `Error ${response.status}: ${response.statusText}`
                                );
                            }
                            return response.text();
                        })
                        .then((markdownContent) => {
                            let [finalHtml, sidebarContent, finalJS] = renderMarkdown(markdownContent);

                            setContent(finalHtml);

                            // Extract title from first h1
                            const titleMatch =
                                markdownContent.match(/^#\s+(.+)$/m);
                            if (titleMatch) {
                                setTitle(titleMatch[1]);
                                document.title = titleMatch[1] + " - Blog Code";
                            }

                            setLoading(false);

                            // Apply syntax highlighting after rendering
                            setTimeout(() => {
                                if (window.Prism) {
                                    window.Prism.highlightAll();
                                }
                                initSidebar(sidebarContent);
                                eval(finalJS);
                            }, 100);
                        })
                        .catch((err) => {
                            console.error("Error loading entry:", err);
                            setError(err.message);
                            setLoading(false);
                        });
                }, []);

                return html`
                    <div class="app">
                        <${Header} showSearch=${true} onNavigateToEntry=${handleNavigateToEntry} />
                        
                        <main class="main-container">
                            <${Sidebar} />
                            ${loading ? html`
                                <div class="loading">Loading entry...</div>
                            ` : error ? html`
                                <div class="error">
                                    <h2>Error loading entry</h2>
                                    <p>${error}</p>
                                    <a href="./index.html">← Back to home</a>
                                </div>
                            ` : html`
                                <article class="blog-entry">
                                    <div class="entry-navigation">
                                        <a href="./index.html">← Back to home</a>
                                    </div>
                                    <div
                                        class="entry-content"
                                        dangerouslySetInnerHTML=${{
                                            __html: content,
                                        }}
                                    />
                                </article>
                            `}
                        </main>
                        <footer class="footer">
                            <p>© 2025 Blog Code.</p>
                        </footer>
                    </div>
                `;
            }

            render(html`<${BlogEntry} />`, document.getElementById("app"));

            setTimeout(() => {
                initSidebar([]);
            }, 0);
        </script>
    </body>
</html>
