<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>S4mu31 Code</title>
        <link rel="icon" type="image/png" sizes="32x32" href="Icon.ico">
        <link rel="stylesheet" href="cdn/font/ubuntu-font.css" />
        <link rel="stylesheet" href="styles.css" />
        <link rel="stylesheet" href="cdn/prism/prism-dark-svc.css" />
        <script src="cdn/prism/prism-core.min.js"></script>
        <script src="cdn/prism/prism-autoloader.min.js"></script>
        <script src="script-all-pages.js"></script>
        <script type="importmap">
            {
                "imports": {
                    "preact": "./cdn/preact/preact.mjs",
                    "preact/hooks": "./cdn/preact/hooks.mjs",
                    "htm/preact": "./cdn/preact/htm-preact.mjs"
                }
            }
        </script>
        <style>
            ::view-transition-old(root) {
                animation: slide-out-to-right 0.5s forwards;
                z-index: 2;
            }

            ::view-transition-new(root) {
                animation: do-nothing-animation 0.5s forwards;
                z-index: 1;
            }

            @keyframes slide-out-to-right {
                from {
                    transform: translate(0);
                }
                to {
                    transform: translate(100%);
                }
            }
        </style>
    </head>
    <body>
        <div id="app"></div>

        <script type="module">
            import { render } from "preact";
            import { useState, useEffect, useRef } from "preact/hooks";
            import { html } from "htm/preact";

            function SearchResults({ results, selectedIndex, onSelect }) {
                return html`
                    <div class="search-results">
                        ${results.map(
                            (result, index) => html`
                                <div
                                    key=${result.path}
                                    class=${`search-result-item ${
                                        index === selectedIndex
                                            ? "selected"
                                            : ""
                                    }`}
                                    onClick=${() => onSelect(result)}
                                >
                                    <h3>${result.title}</h3>
                                    <p>${result.summary}</p>
                                </div>
                            `
                        )}
                    </div>
                `;
            }

            function SearchBar({ onSearch, onNavigateToEntry }) {
                const [query, setQuery] = useState("");
                const [results, setResults] = useState([]);
                const [selectedIndex, setSelectedIndex] = useState(-1);
                const [searchData, setSearchData] = useState([]);
                const inputRef = useRef();

                useEffect(() => {
                    // Cargar datos de búsqueda
                    fetch("./buscador.json")
                        .then((res) => res.json())
                        .then((data) => setSearchData(data.entries || []))
                        .catch((err) =>
                            console.error("Error loading search data:", err)
                        );
                }, []);

                // Función para normalizar texto (eliminar tildes y caracteres especiales)
                function normalizeText(text) {
                    return (
                        text
                            ?.normalize("NFD")
                            .replace(/\p{Diacritic}/gu, "")
                            .toLowerCase() || ""
                    );
                }

                useEffect(() => {
                    if (query.trim()) {
                        const normalizedQuery = normalizeText(query);
                        const filteredResults = searchData.filter((entry) => {
                            const title = normalizeText(entry.title);
                            const summary = normalizeText(entry.summary);
                            const tags = entry.tags?.map(normalizeText) || [];
                            return (
                                title.includes(normalizedQuery) ||
                                summary.includes(normalizedQuery) ||
                                tags.some((tag) =>
                                    tag.includes(normalizedQuery)
                                )
                            );
                        });
                        setResults(filteredResults);
                        setSelectedIndex(filteredResults.length > 0 ? 0 : -1);
                    } else {
                        setResults([]);
                        setSelectedIndex(-1);
                    }
                }, [query, searchData]);

                useEffect(() => {
                    if (results.length > 0) {
                        document.body.style.overflow = "hidden";
                    } else {
                        document.body.style.overflow = "auto";
                    }
                }, [results]);

                const handleKeyDown = (e) => {
                    switch (e.key) {
                        case "ArrowDown":
                            if (results.length === 0) return;
                            e.preventDefault();
                            setSelectedIndex((prev) =>
                                prev < results.length - 1 ? prev + 1 : 0
                            );
                            break;
                        case "ArrowUp":
                            if (results.length === 0) return;
                            e.preventDefault();
                            setSelectedIndex((prev) =>
                                prev > 0 ? prev - 1 : results.length - 1
                            );
                            break;
                        case "Enter":
                            if (results.length === 0) return;
                            e.preventDefault();
                            if (selectedIndex >= 0 && results[selectedIndex]) {
                                onNavigateToEntry(results[selectedIndex]);
                            }
                            break;
                        case "Escape":
                            setQuery("");
                            setResults([]);
                            inputRef.current?.blur();
                            break;
                    }
                };

                const handleSelect = (result) => {
                    onNavigateToEntry(result);
                };

                return html`
                    <div class="search-container">
                        ${results.length > 0 &&
                        html`
                            <div
                                class="search-overlay"
                                onClick=${() => {
                                    setQuery("");
                                    setResults([]);
                                    inputRef.current?.blur();
                                }}
                            ></div>
                        `}
                        <div class="search-bar">
                            <input
                                ref=${inputRef}
                                type="text"
                                autocomplete="off"
                                placeholder="Buscar entradas del blog..."
                                value=${query}
                                onInput=${(e) => setQuery(e.target.value)}
                                onKeyDown=${handleKeyDown}
                                class="search-input"
                                id="search-input"
                            />
                            <div class="search-icon">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="24"
                                    height="24"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        fill="currentColor"
                                        d="M9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l5.6 5.6q.275.275.275.7t-.275.7t-.7.275t-.7-.275l-5.6-5.6q-.75.6-1.725.95T9.5 16m0-2q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"
                                    />
                                </svg>
                            </div>
                        </div>
                        ${results.length > 0 &&
                        html`
                            <${SearchResults}
                                results=${results}
                                selectedIndex=${selectedIndex}
                                onSelect=${handleSelect}
                            />
                        `}
                    </div>
                `;
            }

            function BlogList({ entries }) {
                return html`
                    <div class="blog-list">
                        <h2>Entradas Recientes</h2>
                        ${entries.map(
                            (entry) => html`
                                <article
                                    key=${entry.path}
                                    class="blog-entry-card"
                                >
                                    <h3>
                                        <a
                                            href=${`./entrada.html?path=${encodeURIComponent(
                                                entry.path
                                            )}`}
                                        >
                                            ${entry.title}
                                        </a>
                                    </h3>
                                    <p class="entry-summary">
                                        ${entry.summary}
                                    </p>
                                    <div class="entry-meta">
                                        <span class="entry-date"
                                            >${entry.date}</span
                                        >
                                        ${entry.tags &&
                                        html`
                                            <div class="entry-tags">
                                                ${entry.tags.map(
                                                    (tag) => html`
                                                        <span
                                                            key=${tag}
                                                            class="tag"
                                                            >${tag}</span
                                                        >
                                                    `
                                                )}
                                            </div>
                                        `}
                                    </div>
                                </article>
                            `
                        )}
                    </div>
                `;
            }

            function App() {
                const [entries, setEntries] = useState([]);

                useEffect(() => {
                    fetch("./buscador.json")
                        .then((res) => res.json())
                        .then((data) => setEntries(data.entries || []))
                        .catch((err) =>
                            console.error("Error loading entries:", err)
                        );
                }, []);

                const handleNavigateToEntry = (entry) => {
                    window.location.href = `./entrada.html?path=${encodeURIComponent(
                        entry.path
                    )}`;
                };

                return html`
                    <div class="app">
                        <header class="header">
                            <h1><a href="./index.html">S4mu31 Code</a></h1>
                            <nav class="nav">
                                <a href="./index.html">Inicio</a>
                                <a href="./editor.html">Editor</a>
                            </nav>
                        </header>

                        <main class="main-container">
                            <${SearchBar}
                                onNavigateToEntry=${handleNavigateToEntry}
                            />
                            <${BlogList} entries=${entries} />
                        </main>

                        <footer class="footer">
                            <p>© 2025 S4mu31 Code.</p>
                        </footer>
                    </div>
                `;
            }

            render(html`<${App} />`, document.getElementById("app"));
        </script>
    </body>
</html>
